name: Automatic Testing

on:
  workflow_dispatch:
  pull_request:

jobs:
  e2e:
    name: End-to-end Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Create `env_passphrase` file for decryption of environment variables
        run: echo -n ${{ secrets.ENV_PASSPHRASE }} > env_passphrase

      - name: Build `docker-compose.dev.yml`
        run: make build-dev

      - name: Build `docker-compose.test.yml`
        run: make build-tests

      - name: Decrypt environment variables stored in `env.zip.gpg`
        run: make decrypt-env

      - name: Run the end-to-end tests
        run: make tests
